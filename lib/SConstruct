Import("env")
import pdb
import SCons.Util, SCons.Subst
import SconsUtils.utils as utils

env = env.Clone()

source_files = """
#lib/class.c #lib/talloc.c
#lib/misc.c #lib/zip.c #lib/stringio.c #lib/resolver.c
#lib/rdf.c  #lib/image.c #lib/map.c
#lib/encode.c #lib/queue.c
#lib/encrypt.c
"""

## Optional support for EWF and AFF1 volumes
if utils.HEADERS.get("HAVE_EWF"):
    source_files += "  #lib/ewfvolume.c "

uuid_files = """
#uuid/clear.c    #uuid/copy.c      #uuid/gen_uuid_nt.c  #uuid/pack.c
#uuid/unparse.c
#uuid/compare.c  #uuid/gen_uuid.c  #uuid/isnull.c       #uuid/parse.c
#uuid/unpack.c   #uuid/uuid_time.c
"""

## We compile these statically into our library to ensure users dont
## need tdb as a dependency and also to ensure we can port tdb for
## windows.
tdb_files = """
#libtdb/dump.c   #libtdb/freelist.c       #libtdb/io.c    #libtdb/open.c
#libtdb/transaction.c
#libtdb/error.c  #libtdb/freelistcheck.c  #libtdb/lock.c  #libtdb/tdb.c
#libtdb/traverse.c
"""

env.Append(CPPFLAGS = ['-DHAVE_VA_COPY', '-Ilibreplace/'])

env.libaff4_sources = Split(source_files +
                            uuid_files +
                            tdb_files)

library = env.VersionedSharedLibrary("aff4", '0', env.libaff4_sources)

env.InstallVersionedSharedLibrary("${prefix}/lib/", library)
env.Alias('install', '${prefix}')

utils.libaff4_static_lib = env.StaticLibrary('aff4', env.libaff4_sources)
